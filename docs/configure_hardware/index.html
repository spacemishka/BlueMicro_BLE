<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="BlueMicro nRF52 Keyboard Firmware RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="BlueMicro nRF52 Keyboard Firmware Atom Feed"><title data-react-helmet="true">Configuring hardware_config.h | BlueMicro nRF52 Keyboard Firmware</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="http://bluemicro.jpconstantineau.com//docs/configure_hardware"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Configuring hardware_config.h | BlueMicro nRF52 Keyboard Firmware"><meta data-react-helmet="true" name="description" content="Configuring your keyboard - Part 1: Hardware Definition"><meta data-react-helmet="true" property="og:description" content="Configuring your keyboard - Part 1: Hardware Definition"><link data-react-helmet="true" rel="icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAAAAABoBQAAFgAAACgAAAAQAAAAIAAAAAEACAAAAAAAAAEAAAAAAAAAAAAAAAEAAAAAAADzVwEA01UhAO6OXwDzUgcA+JZ6APjUxAD4n4IA81ECAOjo6AD35dcA81cCAPRXGwD4oX0A+c+6APNpMwDLn40A/fHnAPX19QD27+0A+unlANTBugD88+oA81MnAPJJAQD++PUA+dPAAP3p3QDzSQEA/e/lAPNLDADHk34A8kAKAL2vrAD96+AA+JhuAP7x6AD5qoYA81IBAP328wDzUhoA+a2GAPNVAQDyWAEA81gBAPJJAgD//v4A9GQqAPz08QD839EA8k8CAPWVZwDtWhUA7l4SAO1RBQD97uEAx2g6APenfwD+7uEA/efcAPJVAgD97eQA70gOAP7t5AD4zrcA/ePXAPiWbQD96d8A8kQJAOp1PgDXnooA9G0zAPnw7QD08vAA+rmgALd8ZwD4zrgA9GIpAPJKAQD5qIYA7V0fAORnNQDzUwEA2djYAPNWAQD87eYA81kBAPjOuQD+8OYA9fT0APBNAgDxNgkA/ezhAPVuMgD5sY8A4WcuAPmwkgD4lG0A81kCAMaUgADHlIAA////APJFCQDwUAMA8WMYAO/UywDtTwYA9X1LAPmxkADySyIAyJJ+ALWqpwDyVCoA0F0rAM1vQwDBmokA/uvdAOmFXwDxTgEA+KqDAPvj2wDzTgEAxV00APRlLAD25d4Awb28APF6RAD97OMA81QBAPFFAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAZGRkZGRkEQgIEWRkZGRkZGRkZGRIRXFwN0p8ZGRkZGRkZGQSUDsdKBs7AW5kZGRkZGRkdCoKQyMkGyt5UmRkZGRkR2kDB2VXPE4sNSBkZGRkZAUXa11aNhYVOHVyZGRkZGQNfwtABiFBW0YpYmRkZGRkS1MpJzAtfnolVR5kZGRkZD8ACk0EZEmACmFtZGRkZGRWU01gQhg6XywrY2RkZGRkGXgiHG9zbBB2MQ9kZGRkZFRZalwfOQwaDmYUZGRkZGRkfSkpZRA+TFFeWGRkZGRkZHdnAD0JLiU0aGRkZGRkZGRkZDJPRDMCe2RkZGRkZGRkZGRkJhMvZGRkZGRkZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA="><link data-react-helmet="true" rel="canonical" href="http://bluemicro.jpconstantineau.com//docs/configure_hardware"><link data-react-helmet="true" rel="alternate" href="http://bluemicro.jpconstantineau.com//docs/configure_hardware" hreflang="en"><link data-react-helmet="true" rel="alternate" href="http://bluemicro.jpconstantineau.com//docs/configure_hardware" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.00613c63.css">
<link rel="preload" href="/assets/js/runtime~main.c2b59094.js" as="script">
<link rel="preload" href="/assets/js/main.b5ea2683.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="BlueMicro Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/logo.png" alt="BlueMicro Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">BlueMicro nRF52 Keyboard Firmware</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="http://nrf52.jpconstantineau.com/docs/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>BlueMicro Hardware<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/jpconstantineau/Community_nRF52_Arduino/wiki" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Community nRF52 Arduino Support<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/jpconstantineau/BlueMicro_BLE" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">ðŸŒœ</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">ðŸŒž</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/">Introduction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/features">Features</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" href="/docs/tools">How To</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tools">Installing Tools</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/understand_gpios">Understand GPIOs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/configure_hardware">Configuring hardware_config.h</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/configure_keyboard">Configuring keyboard_config.h</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/configure_keymap">Configuring keymap.h.cpp</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/configure_combos">Configuring Advanced Features</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/keymaps">Configuring your own keymap</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/build">Building Firmware</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/flash">Flashing Firmware to your keyboard</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/add">Adding a new Keyboard</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/customize_BSP">Customizing Adafruit BSP</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/keycodes_basic">Keycodes</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/tut_base">Tutorials</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/trouble/trouble_flash">Troubleshooting</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/docs/style_guide">Contributing</a></div></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Configuring hardware_config.h</h1></header><h2 class="anchor anchorWithStickyNavbar_y2LR" id="configuring-your-keyboard---part-1-hardware-definition">Configuring your keyboard - Part 1: Hardware Definition<a class="hash-link" href="#configuring-your-keyboard---part-1-hardware-definition" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="matrix-definition">Matrix Definition<a class="hash-link" href="#matrix-definition" title="Direct link to heading">â€‹</a></h3><p>Most keyboards use a matrix of columns and rows to scan each key.  You will need to refer to the keyboard schematic to identify how many columns and rows your keyboard uses for it&#x27;s scanning matrix.  The scanning matrix may differ from the keyboard layout.  For example, a 4x12 matrix uses 16 GPIOs and allows for 48 keys to be scanned.  A 8x8 matrix also uses 16 GPIOs but will allow 64 keys to be scanned.  The mapping of each key in the scanning matrix to the keyboard layout is done in the KEYMAP macro definition in keyboard_config.h.</p><p><img src="http://bluemicro.jpconstantineau.com/img/keyboardmatrix.png" alt="keyboard matrix"></p><p>In the image above, we see that this keyboard has a matrix of 4 rows, with 7 columns.  The direction of the diodes goes from the columns to the rows.  With this information, we can define the following:</p><div class="codeBlockContainer_J+bg language-c++ theme-code-block"><div class="codeBlockContent_csEI c++"><pre tabindex="0" class="prism-code language-c++ codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#define MATRIX_ROWS 4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#define MATRIX_COLS 7</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#define DIODE_DIRECTION COL2ROW</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Next, we need to identify how each row and column are mapped to the microntroller on board of the nRF52 module you use.  Since most DIY keyboards use the Arduino Pro Micro as its controller, we are using such an example.</p><p><img src="http://bluemicro.jpconstantineau.com/img/gpiomapping.png" alt="GPIO Mapping"></p><p>With the information from both the keyboard and controller schamatics, we can map each row and column to the GPIO and using the formula shown in the previous section, we can define the configuration needed: </p><div class="codeBlockContainer_J+bg language-c++ theme-code-block"><div class="codeBlockContent_csEI c++"><pre tabindex="0" class="prism-code language-c++ codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#define MATRIX_ROW_PINS {13, 24, 9, 10 }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#define MATRIX_COL_PINS {26, 29, 2, 45, 3, 28, 43 }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="status-leds">Status LEDs<a class="hash-link" href="#status-leds" title="Direct link to heading">â€‹</a></h3><p>Most controllers will have 1 or 2 LEDs to let the user know of the status of the board.  To configure the firmware to use these LEDs, you need to set at least the PIN definition for the LED.
By default, when <code>STATUS_BLE_LED_PIN</code> or <code>STATUS_KB_LED_PIN</code> are defined, both the <code>ACTIVE</code> and <code>POLARITY</code> settings will default to 1.</p><div class="codeBlockContainer_J+bg language-c++ theme-code-block"><div class="codeBlockContent_csEI c++"><pre tabindex="0" class="prism-code language-c++ codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">    #define  STATUS_BLE_LED_PIN  19  //blue = 0.19</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    #define  BLE_LED_ACTIVE 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    #define  BLE_LED_POLARITY 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    #define  STATUS_KB_LED_PIN 17  //red = 0.17</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    #define  STATUS_KB_LED_ACTIVE 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    #define  STATUS_KB_LED_POLARITY 1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>If you want to keep the definition of the PIN but want to disable the use of the specific status LED, you need to set the <code>ACTIVE</code> to <code>0</code>.  </p><p>By default, setting a <code>1</code> on the GPIO will turn on the LED.  If this logic is reversed, set <code>POLARITY</code> to <code>0</code>.</p><p>If your board does not have the LED defined but it&#x27;s status does not change, you need to configure the PIN so that it can be updated to match the state of the keyboard.</p><p>Note that when going to sleep, the enabled pins will go in a low power mode (INPUT) and will turn off the LEDs.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="battery-monitoring">Battery Monitoring<a class="hash-link" href="#battery-monitoring" title="Direct link to heading">â€‹</a></h3><p>Battery Monitoring is a function that&#x27;s specific to the controller you use.  Most controllers implement an on-board battery charger and battery monitoring voltage divider and connect this divider to an analog input.  Such a configuration is shown below:</p><p><img src="http://bluemicro.jpconstantineau.com/img/batterymonitoring.png" alt="Battery Monitoring"></p><p>From the schematic, we identify that the connection point of the voltage divider is connected to 0.31. This leads to this definition:</p><div class="codeBlockContainer_J+bg language-c++ theme-code-block"><div class="codeBlockContent_csEI c++"><pre tabindex="0" class="prism-code language-c++ codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#define BATTERY_TYPE BATT_LIPO</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#define VBAT_PIN  31</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>If a non-rechargeable CR2032 (3V) powers your keyboard and the battery is directly connected to the nRF5 chip through VDD, you don&#x27;t need to define a <code>VBATT_PIN</code>  but since the nrf52 chip can measure its own supply voltage, it will not use this configuration. All you need to do is to use this definition:</p><div class="codeBlockContainer_J+bg language-c++ theme-code-block"><div class="codeBlockContent_csEI c++"><pre tabindex="0" class="prism-code language-c++ codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#define BATTERY_TYPE BATT_CR2032</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>If a Lithion Ion (LiPo) rechargeable battery (3.7-4.2V) powers your keyboard and the battery is directly connected to the nRF52840 chip through VDDH, you don&#x27;t need to define a <code>VBATT_PIN</code> since the nrf52 chip can measure its own supply voltage All you need to do is to use this definition:</p><div class="codeBlockContainer_J+bg language-c++ theme-code-block"><div class="codeBlockContent_csEI c++"><pre tabindex="0" class="prism-code language-c++ codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#define BATTERY_TYPE BATT_VDDH</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Note that only the nRF52840 has VDDH to provide power at a voltage higher than 3.6V. </p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="external-vcc-switching">External VCC Switching<a class="hash-link" href="#external-vcc-switching" title="Direct link to heading">â€‹</a></h3><p>Some controllers implement switching of external VCC to ensure low power consumption.  Polarity of switching will depend on the hardware implementation.  Refer to the controller documentation and/or schematic to identify if VCC switching is available, which GPIO it is connected to and polarity of the switch.</p><div class="codeBlockContainer_J+bg language-c++ theme-code-block"><div class="codeBlockContent_csEI c++"><pre tabindex="0" class="prism-code language-c++ codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#define VCC_PIN 12</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#define VCC_POLARITY_ON 1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>If <code>VCC_PIN</code> is left undefined, VCC switching functionality will not be enabled in the firmware.</p><p>By default, <code>VCC_POLARITY_ON</code> is defined with 1. You only need to define it if polarity is reversed. (replace 1 with 0)</p><p>By default, the firmware will turn on external VCC when booting up and will turn off External VCC when going to sleep.  If you want to force external VCC to be off at bootup, you can add this definition to your <strong>hardware_config.h</strong> file.</p><div class="codeBlockContainer_J+bg language-c++ theme-code-block"><div class="codeBlockContent_csEI c++"><pre tabindex="0" class="prism-code language-c++ codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#define VCC_DEFAULT_ON 0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="lipo-charger-switching">LiPo Charger Switching<a class="hash-link" href="#lipo-charger-switching" title="Direct link to heading">â€‹</a></h3><p>Some controllers implement turning off the LiPo Charger to allow for a more precise battery level measurement.  Switching polarity will depend on the hardware implementation.  Refer to the controller documentation and/or schematic to identify if charger switching is available, which GPIO it is connected to and polarity to enable charging.</p><div class="codeBlockContainer_J+bg language-c++ theme-code-block"><div class="codeBlockContent_csEI c++"><pre tabindex="0" class="prism-code language-c++ codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">     #define CHARGER_PIN  5</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     #define CHARGER_POLARITY_ON 0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>If <code>CHARGER_PIN</code> is left undefined, charger switching functionality will not be enabled in the firmware. By default, the firmware will turn on charger when booting up and will not change it at any time.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="backlight-pwm-led-definition">Backlight PWM LED Definition<a class="hash-link" href="#backlight-pwm-led-definition" title="Direct link to heading">â€‹</a></h3><p>Some keyboards have backlit keys using LEDs controlled by a central mosfet.  The brightness of these LEDs can be modulated using Pulse Width Modulation (PWM). When referring to the keyboard and controller schematics above, we see that GPIO 1.06 is connected to the LED Backlight.</p><p> <img src="http://bluemicro.jpconstantineau.com/img/gpiomapping.png" alt="GPIO Mapping"></p><p>This enables setting up the following configuration:</p><div class="codeBlockContainer_J+bg language-c++ theme-code-block"><div class="codeBlockContent_csEI c++"><pre tabindex="0" class="prism-code language-c++ codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">    #define BACKLIGHT_LED_PIN 38</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    #define BACKLIGHT_PWM_ON 1 </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    #define DEFAULT_PWM_VALUE 10000  // Reduce max PWM to 10000 out of 63351 (0x7FFF)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>If <code>BACKLIGHT_LED_PIN</code> is left undefined, LED functionality will not be enabled in the firmware.
<code>BACKLIGHT_PWM_ON</code> is optional. If <code>BACKLIGHT_LED_PIN</code> is defined, but you want to turn off LED functionality, you can do so by setting <code>BACKLIGHT_PWM_ON</code> to 0.
If <code>DEFAULT_PWM_VALUE</code> is left undefined, the default value will be that of maximum PWM value of 63351 (0x7FFF).  This will turn on LEDs on fully.</p><p>Turning on the PWM peripheral on the nRF52 chip uses approximately 0.5mA, not including the power used by the LED themselves.  As such, when the PWM value is set to 0, the firmware turns off the PWM peripheral it uses for controlling the brightness of the LEDs. It does the same prior to going to sleep. </p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="rgb-led-definition">RGB LED Definition<a class="hash-link" href="#rgb-led-definition" title="Direct link to heading">â€‹</a></h3><p>Some keyboards have RGB LEDs.  These LEDs are controlled through a single data line. When referring to the keyboard and controller schematics above, we see that GPIO 0.06 is connected to the RGB WS2812 LEDs.</p><p> <img src="http://bluemicro.jpconstantineau.com/img/gpiomapping.png" alt="GPIO Mapping"></p><p>This enables setting up the following configuration:</p><div class="codeBlockContainer_J+bg language-c++ theme-code-block"><div class="codeBlockContent_csEI c++"><pre tabindex="0" class="prism-code language-c++ codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">    #define WS2812B_LED_PIN 6</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    #define WS2812B_LED_COUNT 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    #define WS2812B_LED_ON 1 </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>If <code>WS2812B_LED_PIN</code> is left undefined, LED functionality will not be enabled in the firmware.
If <code>WS2812B_LED_ON</code> is set to 0, RGB functionality will not be enabled in the firmware. Note that this will not power down VCC power to the RGB LEDs, impacting power consumption of your keyboard.  External VCC to the RGB LEDs is controlled through the <strong>External VCC Switch</strong> functionality described above.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="oled-definition">OLED Definition<a class="hash-link" href="#oled-definition" title="Direct link to heading">â€‹</a></h3><p>OLED displays are implemented using the U8g2 Library and assumes that the display uses I2C as the communication interface.  This interface is defined by the SDA and SCK pins.  For all keyboards designed to work with Arduino Pro Micros, these relate to the D1 and D0 AVR ports. nRF52 chips can relocate this interface to other GPIOs.</p><div class="codeBlockContainer_J+bg language-c++ theme-code-block"><div class="codeBlockContent_csEI c++"><pre tabindex="0" class="prism-code language-c++ codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">    #define I2C_SDA_PIN 15</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    #define I2C_SCK_PIN 17</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    #define DISPLAY_U8G2_CONSTRUCTOR U8G2_SSD1306_128X32_UNIVISION_F_HW_I2C // see https://github.com/olikraus/u8g2/wiki/u8g2setupcpp for reference</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Since the U8g2 library supports a large number of displays by changing the type (hence changing the constructor method), changing the disply type is as simple as selecting a different constructor.  See <a href="https://github.com/olikraus/u8g2/wiki/u8g2setupcpp" target="_blank" rel="noopener noreferrer">the u8g2 setup documentation</a> for more information.  The firmware assumes hardware I2C as parameters passed to the constructors.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="rotary-encoder-definition">Rotary Encoder Definition<a class="hash-link" href="#rotary-encoder-definition" title="Direct link to heading">â€‹</a></h3><p>Hardware quadrature decoder only supports a single Rotary encoder per side/half. If you need more than 1 encoder, you can use the software (interrupt driven) quadrature decoder, which supports up to 8 encoders per side.</p><p>Add these lines to your <code>hardware_config.h</code> if you use a single encoder.</p><div class="codeBlockContainer_J+bg language-c++ theme-code-block"><div class="codeBlockContent_csEI c++"><pre tabindex="0" class="prism-code language-c++ codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#define ENCODER_A_PIN  26 </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#define ENCODER_B_PIN  30</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#define ENCODER_RESOLUTION 2  </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>If you use multiple encoders, you can expand the above to an array as follows:</p><div class="codeBlockContainer_J+bg language-c++ theme-code-block"><div class="codeBlockContent_csEI c++"><pre tabindex="0" class="prism-code language-c++ codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#define ENCODER_PAD_A  {26, 8, 15, 17, 9 }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#define ENCODER_PAD_B  {6, 29, 2, 20, 13 }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#define ENCODER_RESOLUTION 2 </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>From a hardware point of view, the A an B lines of the encoder should be wired directly to the nRF52 GPIO. The C (or common) line should be wired to ground. By default, the configuration uses the hardware QDEC peripheral (Quadrature Decoder) that&#x27;s part of the nRF52 SoC and uses callbacks to handle rotation.  If you need more than 1 encoder (per side) you will need to use the software implemention.</p><p>Encoder resolution is used within the encoder callbacks to divide the steps in case you get multiple steps per click. </p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="speakerbuzzeraudio-definition">Speaker/Buzzer/Audio Definition<a class="hash-link" href="#speakerbuzzeraudio-definition" title="Direct link to heading">â€‹</a></h3><p>Audio functions are based on the Tone functionality of the Adafruit nRF52 Arduino Core.  They send a PWM Signal to the <code>SPEAKER_PIN</code> GPIO.  If <code>SPEAKER_PIN</code> is not defined, audio functions won&#x27;t work.   Add this line to your <code>hardware_config.h</code></p><div class="codeBlockContainer_J+bg language-c++ theme-code-block"><div class="codeBlockContent_csEI c++"><pre tabindex="0" class="prism-code language-c++ codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#define SPEAKER_PIN 10</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>With only this definition, you will have basic audio feedback functionality enabled.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/jpconstantineau/BlueMicro_BLE/tree/documentation-docusaurus/documentation/docs/configuring_firmware_1.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/understand_gpios"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Understand GPIOs</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/configure_keyboard"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Configuring keyboard_config.h</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#configuring-your-keyboard---part-1-hardware-definition" class="table-of-contents__link toc-highlight">Configuring your keyboard - Part 1: Hardware Definition</a><ul><li><a href="#matrix-definition" class="table-of-contents__link toc-highlight">Matrix Definition</a></li><li><a href="#status-leds" class="table-of-contents__link toc-highlight">Status LEDs</a></li><li><a href="#battery-monitoring" class="table-of-contents__link toc-highlight">Battery Monitoring</a></li><li><a href="#external-vcc-switching" class="table-of-contents__link toc-highlight">External VCC Switching</a></li><li><a href="#lipo-charger-switching" class="table-of-contents__link toc-highlight">LiPo Charger Switching</a></li><li><a href="#backlight-pwm-led-definition" class="table-of-contents__link toc-highlight">Backlight PWM LED Definition</a></li><li><a href="#rgb-led-definition" class="table-of-contents__link toc-highlight">RGB LED Definition</a></li><li><a href="#oled-definition" class="table-of-contents__link toc-highlight">OLED Definition</a></li><li><a href="#rotary-encoder-definition" class="table-of-contents__link toc-highlight">Rotary Encoder Definition</a></li><li><a href="#speakerbuzzeraudio-definition" class="table-of-contents__link toc-highlight">Speaker/Buzzer/Audio Definition</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Getting Started</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://discord.gg/ecnCR9P" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UCFpGp4hHe03nvF9c8_gF_jA" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>YouTube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/jpconstantineau/BlueMicro_BLE" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Pierre Constantineau. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.c2b59094.js"></script>
<script src="/assets/js/main.b5ea2683.js"></script>
</body>
</html>